<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Finaliza tu compra en ShopFlourite. Proceso de checkout seguro y r√°pido.">
  <title>Carrito y Checkout | ShopFlourite</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container">
      <div class="header-content">
        <a href="/index.html" class="logo neon-text">ShopFlourite</a>
        
        <nav>
          <ul>
            <li><a href="/index.html">Inicio</a></li>
            <li><a href="/productos.html">Productos</a></li>
            <li><a href="/novedades.html">Novedades</a></li>
            <li><a href="/soporte.html">Soporte</a></li>
            <li>
              <a href="/checkout.html" style="position: relative; color: var(--primary);">
                üõí Carrito
                <span class="cart-badge badge" style="position: absolute; top: -8px; right: -8px; display: none;">0</span>
              </a>
            </li>
            <li id="auth-links" style="display: flex; gap: 15px;">
              <a href="/login.html" class="btn btn-outline" style="padding: 8px 20px;">Iniciar Sesi√≥n</a>
            </li>
            <li id="user-links" style="display: none; gap: 15px;">
              <span class="user-name" style="color: var(--primary);"></span>
              <a href="/perfil.html">Perfil</a>
              <a href="/mis-compras.html">Mis Compras</a>
              <a href="#" onclick="logout(); return false;">Salir</a>
            </li>
          </ul>
        </nav>
        
        <div class="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </div>
  </header>

  <!-- Checkout Section -->
  <section class="checkout-section mt-5" style="padding: 120px 0 60px;">
    <div class="container">
      <h1 class="neon-text text-center mb-4" style="font-size: 48px;">
        Tu Carrito
      </h1>

      <div style="display: grid; grid-template-columns: 1fr 400px; gap: 30px; align-items: start;">
        <!-- Cart Items -->
        <div>
          <div id="cart-items-container">
            <!-- Cart items will be loaded here -->
          </div>

          <div id="empty-cart" class="card glass text-center" style="padding: 60px; display: none;">
            <div style="font-size: 64px; margin-bottom: 20px;">üõí</div>
            <h3 style="color: var(--text-secondary); margin-bottom: 15px;">Tu carrito est√° vac√≠o</h3>
            <p style="color: var(--text-secondary); margin-bottom: 30px;">
              Agrega productos para comenzar tu compra
            </p>
            <a href="/productos.html" class="btn btn-primary">
              Ver Productos
            </a>
          </div>
        </div>

        <!-- Order Summary -->
        <div id="order-summary" class="card glass" style="position: sticky; top: 100px; padding: 30px; display: none;">
          <h3 class="mb-3" style="color: var(--primary);">Resumen del Pedido</h3>
          
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <span style="color: var(--text-secondary);">Subtotal:</span>
              <span id="subtotal">‚Ç¨0.00</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <span style="color: var(--text-secondary);">Env√≠o:</span>
              <span id="shipping">Gratis</span>
            </div>
            <div style="border-top: 1px solid var(--glass-border); padding-top: 15px; margin-top: 15px;">
              <div style="display: flex; justify-content: space-between; font-size: 20px; font-weight: 700;">
                <span>Total:</span>
                <span class="neon-text" id="total">‚Ç¨0.00</span>
              </div>
            </div>
          </div>

          <button 
            class="btn btn-primary" 
            style="width: 100%; margin-bottom: 15px;"
            onclick="proceedToCheckout()"
          >
            Proceder al Pago
          </button>

          <a href="/productos.html" class="btn btn-outline" style="width: 100%; text-align: center;">
            Continuar Comprando
          </a>
        </div>
      </div>

      <!-- Checkout Form (Hidden initially) -->
      <div id="checkout-form-section" class="mt-5" style="display: none;">
        <div class="card glass" style="padding: 40px; max-width: 800px; margin: 0 auto;">
          <h2 class="neon-secondary mb-4">Informaci√≥n de Env√≠o</h2>
          
          <form id="checkout-form">
            <div class="grid grid-2">
              <div class="form-group">
                <label>Nombre Completo *</label>
                <input type="text" id="checkout-name" required>
              </div>

              <div class="form-group">
                <label>Tel√©fono / WhatsApp *</label>
                <input type="tel" id="checkout-phone" required>
              </div>
            </div>

            <div class="form-group">
              <label>Email *</label>
              <input type="email" id="checkout-email" required>
            </div>

            <div class="form-group">
              <label>Direcci√≥n Completa *</label>
              <input type="text" id="checkout-address" placeholder="Calle, n√∫mero, piso..." required>
            </div>

            <div class="grid grid-3">
              <div class="form-group">
                <label>Ciudad *</label>
                <input type="text" id="checkout-city" required>
              </div>

              <div class="form-group">
                <label>Provincia *</label>
                <input type="text" id="checkout-state" required>
              </div>

              <div class="form-group">
                <label>C√≥digo Postal *</label>
                <input type="text" id="checkout-zip" required>
              </div>
            </div>

            <div class="form-group">
              <label>Pa√≠s *</label>
              <input type="text" id="checkout-country" value="Espa√±a" required>
            </div>

            <div class="form-group">
              <label>Notas del Pedido (Opcional)</label>
              <textarea id="checkout-notes" rows="3" placeholder="Instrucciones especiales de entrega..."></textarea>
            </div>

            <h3 class="neon-secondary mb-3 mt-4">M√©todo de Pago</h3>
            
            <div class="form-group">
              <select id="payment-method" required>
                <option value="">Selecciona un m√©todo de pago</option>
                <option value="transfer">Transferencia Bancaria</option>
                <option value="paypal">PayPal</option>
                <option value="card">Tarjeta de Cr√©dito/D√©bito</option>
                <option value="cash">Efectivo contra entrega</option>
              </select>
            </div>

            <div id="payment-instructions" class="alert alert-warning mt-3" style="display: none;">
              <!-- Payment instructions will appear here -->
            </div>

            <div class="mt-4" style="display: flex; gap: 15px;">
              <button type="submit" class="btn btn-primary" style="flex: 1;">
                Confirmar Pedido
              </button>
              <button type="button" class="btn btn-outline" onclick="cancelCheckout()">
                Cancelar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="mt-5">
    <div class="container">
      <div class="footer-bottom text-center" style="padding: 20px 0;">
        <p>&copy; 2024 ShopFlourite. Todos los derechos reservados.</p>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="/js/main.js"></script>
  <script>
    function renderCart() {
      const cart = ShopFlourite.getCart();
      const container = document.getElementById('cart-items-container');
      const emptyCart = document.getElementById('empty-cart');
      const summary = document.getElementById('order-summary');

      if (cart.length === 0) {
        container.innerHTML = '';
        emptyCart.style.display = 'block';
        summary.style.display = 'none';
        return;
      }

      emptyCart.style.display = 'none';
      summary.style.display = 'block';

      container.innerHTML = cart.map(item => `
        <div class="card glass mb-3" style="padding: 20px;">
          <div style="display: grid; grid-template-columns: 120px 1fr auto; gap: 20px; align-items: center;">
            <img 
              src="${item.image || 'https://via.placeholder.com/120'}" 
              alt="${item.name}"
              style="width: 100%; height: 120px; object-fit: cover; border-radius: 10px;"
            >
            
            <div>
              <h3 style="margin-bottom: 10px;">${item.name}</h3>
              <p style="color: var(--primary); font-size: 20px; font-weight: 700;">
                ${ShopFlourite.formatPrice(item.price)}
              </p>
            </div>
            
            <div style="text-align: right;">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <button 
                  class="btn btn-outline" 
                  style="padding: 5px 15px;"
                  onclick="changeQuantity('${item.id}', ${item.quantity - 1})"
                >
                  -
                </button>
                <span style="font-size: 18px; min-width: 30px; text-align: center;">${item.quantity}</span>
                <button 
                  class="btn btn-outline" 
                  style="padding: 5px 15px;"
                  onclick="changeQuantity('${item.id}', ${item.quantity + 1})"
                >
                  +
                </button>
              </div>
              <button 
                class="btn" 
                style="background: var(--error); padding: 8px 20px;"
                onclick="removeItem('${item.id}')"
              >
                Eliminar
              </button>
            </div>
          </div>
        </div>
      `).join('');

      updateSummary();
    }

    function updateSummary() {
      const total = ShopFlourite.getCartTotal();
      document.getElementById('subtotal').textContent = ShopFlourite.formatPrice(total);
      document.getElementById('total').textContent = ShopFlourite.formatPrice(total);
    }

    function changeQuantity(productId, newQuantity) {
      if (newQuantity < 1) {
        removeItem(productId);
        return;
      }
      ShopFlourite.updateCartQuantity(productId, newQuantity);
      renderCart();
    }

    function removeItem(productId) {
      if (confirm('¬øEst√°s seguro de eliminar este producto?')) {
        ShopFlourite.removeFromCart(productId);
        renderCart();
        ShopFlourite.showAlert('Producto eliminado del carrito', 'success');
      }
    }

    function proceedToCheckout() {
      const token = localStorage.getItem('token');
      if (!token) {
        ShopFlourite.showAlert('Por favor inicia sesi√≥n para continuar', 'warning');
        setTimeout(() => {
          window.location.href = '/login.html?redirect=/checkout.html';
        }, 1500);
        return;
      }

      document.getElementById('checkout-form-section').style.display = 'block';
      document.getElementById('checkout-form-section').scrollIntoView({ behavior: 'smooth' });

      // Pre-fill user data
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (user.name) document.getElementById('checkout-name').value = user.name;
      if (user.email) document.getElementById('checkout-email').value = user.email;
      if (user.phone) document.getElementById('checkout-phone').value = user.phone;
      
      const whatsappPhone = ShopFlourite.getWhatsAppPhone();
      if (whatsappPhone && !user.phone) {
        document.getElementById('checkout-phone').value = whatsappPhone;
      }
    }

    function cancelCheckout() {
      document.getElementById('checkout-form-section').style.display = 'none';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Payment method change
    document.getElementById('payment-method')?.addEventListener('change', (e) => {
      const instructions = document.getElementById('payment-instructions');
      const method = e.target.value;

      if (!method) {
        instructions.style.display = 'none';
        return;
      }

      instructions.style.display = 'block';
      
      const instructionText = {
        'transfer': 'Despu√©s de confirmar, recibir√°s los datos bancarios por email y WhatsApp para realizar la transferencia.',
        'paypal': 'Ser√°s redirigido a PayPal para completar el pago de forma segura.',
        'card': 'Ingresa los datos de tu tarjeta en la siguiente pantalla de forma segura.',
        'cash': 'Pagar√°s en efectivo cuando recibas tu pedido. Ten el monto exacto preparado.'
      };

      instructions.textContent = instructionText[method] || '';
    });

    // Submit checkout
    document.getElementById('checkout-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!ShopFlourite.validateForm('checkout-form')) {
        ShopFlourite.showAlert('Por favor completa todos los campos requeridos', 'error');
        return;
      }

      const cart = ShopFlourite.getCart();
      if (cart.length === 0) {
        ShopFlourite.showAlert('Tu carrito est√° vac√≠o', 'error');
        return;
      }

      const orderData = {
        items: cart.map(item => ({
          productId: item.id,
          quantity: item.quantity,
          price: item.price
        })),
        shippingAddress: {
          street: document.getElementById('checkout-address').value,
          city: document.getElementById('checkout-city').value,
          state: document.getElementById('checkout-state').value,
          zipCode: document.getElementById('checkout-zip').value,
          country: document.getElementById('checkout-country').value,
          phone: document.getElementById('checkout-phone').value
        },
        paymentMethod: document.getElementById('payment-method').value,
        notes: document.getElementById('checkout-notes').value,
        totalAmount: ShopFlourite.getCartTotal()
      };

      try {
        ShopFlourite.showLoading();
        
        const response = await ShopFlourite.apiRequest('/orders', {
          method: 'POST',
          body: JSON.stringify(orderData)
        });

        ShopFlourite.hideLoading();
        ShopFlourite.clearCart();
        ShopFlourite.showAlert('¬°Pedido realizado con √©xito!', 'success');

        setTimeout(() => {
          window.location.href = `/order-confirmation.html?orderId=${response.order._id}`;
        }, 2000);

      } catch (error) {
        ShopFlourite.hideLoading();
        console.error('Checkout error:', error);
        ShopFlourite.showAlert(error.message || 'Error al procesar el pedido', 'error');
      }
    });

    // Load cart on page load
    document.addEventListener('DOMContentLoaded', renderCart);
  </script>
</body>
</html>
